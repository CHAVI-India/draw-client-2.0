{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - DRAW Client{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ page_title }}</h1>
        <p class="text-gray-600">Configure remote DICOM node connection and capabilities</p>
    </div>

    <!-- Form -->
    <form method="post" class="bg-white rounded-lg shadow-md p-6">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="mb-4 p-4 bg-red-50 text-red-700 rounded">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="space-y-6">
            <!-- Basic Information -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.name.help_text }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.description.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Notes about this remote DICOM node (e.g., location, purpose, contact info)</p>
                    </div>
                    <label class="flex items-center space-x-3">
                        {{ form.is_active }}
                        <span class="text-sm font-medium text-gray-700">Enable this remote node</span>
                    </label>
                    <p class="text-xs text-gray-500 -mt-2 ml-8">Uncheck to temporarily disable without deleting the configuration</p>
                </div>
            </div>

            <!-- Network Configuration -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Network Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Host</label>
                        {{ form.host }}
                        {% if form.host.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.host.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.host.help_text }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Port</label>
                        {{ form.port }}
                        {% if form.port.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.port.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.port.help_text }}</p>
                    </div>
                </div>
            </div>

            <!-- Incoming Connection Settings -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Receive Files Settings (This remote node sends files TO us)</h2>
                <div class="space-y-4">
                    <label class="flex items-center space-x-3">
                        {{ form.allow_incoming }}
                        <span class="text-sm font-medium text-gray-700">Allow Incoming C-STORE (This node can send files to us)</span>
                    </label>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Remote Node's AE Title (when sending to us)</label>
                        {{ form.incoming_ae_title }}
                        {% if form.incoming_ae_title.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.incoming_ae_title.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">The AE Title that the remote node uses when sending files to our server</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Expected IP Address (Optional)</label>
                        {{ form.expected_ip }}
                        {% if form.expected_ip.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.expected_ip.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.expected_ip.help_text }}</p>
                    </div>
                </div>
            </div>

            <!-- Query/Retrieve Capabilities -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Query & Retrieve Settings (Search and get files FROM this remote node)</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Remote Node's AE Title (for queries)</label>
                        {{ form.outgoing_ae_title }}
                        {% if form.outgoing_ae_title.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.outgoing_ae_title.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">The AE Title of the remote node that we use when querying or retrieving files from it</p>
                    </div>
                    <div class="space-y-3">
                        <p class="text-sm text-gray-600 mb-3 italic">Check the capabilities that this remote node supports (what we can do on their server):</p>
                        <label class="flex items-center space-x-3">
                            {{ form.supports_c_find }}
                            <span class="text-sm font-medium text-gray-700">This remote node allows us to search for files (C-FIND)</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            {{ form.supports_c_move }}
                            <span class="text-sm font-medium text-gray-700">This remote node allows us to retrieve files via C-MOVE</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            {{ form.supports_c_get }}
                            <span class="text-sm font-medium text-gray-700">This remote node allows us to retrieve files via C-GET</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-3 bg-yellow-50 border border-yellow-200 rounded p-2">
                            <strong>Note:</strong> These settings indicate what the remote server allows US to do. If the remote server needs to query/retrieve files FROM our server, they must configure our server as a remote node on their system.
                        </p>
                    </div>
                    
                    <!-- C-MOVE Specific Setting -->
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Our Local AE Title (for C-MOVE operations)
                            <span class="text-xs font-normal text-gray-500 ml-2">Only used if C-MOVE is enabled above</span>
                        </label>
                        {{ form.move_destination_ae }}
                        {% if form.move_destination_ae.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.move_destination_ae.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">
                            When using C-MOVE, the remote node needs to know which AE Title to send files to. 
                            <strong>Leave empty to automatically use your server's AE Title from the main configuration.</strong>
                            Only specify a value if you need to override the default.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Advanced Connection Settings -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Advanced Connection Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Query/Retrieve Model</label>
                        {{ form.query_retrieve_model }}
                        {% if form.query_retrieve_model.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.query_retrieve_model.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.query_retrieve_model.help_text }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Timeout (seconds)</label>
                        {{ form.timeout }}
                        {% if form.timeout.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.timeout.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.timeout.help_text }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max PDU Size</label>
                        {{ form.max_pdu_size }}
                        {% if form.max_pdu_size.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.max_pdu_size.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">{{ form.max_pdu_size.help_text }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-4 mt-8 pt-6 border-t">
            <a href="{% url 'dicom_server:remote_nodes_list' %}" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                Cancel
            </a>
            <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                {{ action }} Node
            </button>
        </div>
    </form>
</div>
{% endblock %}
