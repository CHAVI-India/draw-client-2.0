{% extends 'base.html' %}

{% block title %}Create VOI Comparisons - DRAW{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Select VOI Pairs for Comparison</h1>
        <p class="mt-2 text-gray-600">Choose which VOI pairs to compare between the two RT Structure Sets</p>
    </div>

    <!-- RT Structure Set Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
            <div class="flex items-center mb-4">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold text-gray-900">Reference RT Structure Set</h3>
            </div>
            <dl class="space-y-2 text-sm">
                <div>
                    <dt class="text-gray-500">Label</dt>
                    <dd class="text-gray-900 font-medium">{{ rtstruct1.structure_set_label }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Patient ID</dt>
                    <dd class="text-gray-900">{{ rtstruct1.patient_id }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Number of VOIs</dt>
                    <dd class="text-gray-900">{{ vois1.count }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">RT Structure Series UID</dt>
                    <dd class="text-gray-900 font-mono text-xs break-all">{{ rtstruct1.series_instance_uid }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Referenced Image Series UID</dt>
                    <dd class="text-gray-900 font-mono text-xs break-all">{{ rtstruct1.referenced_series_instance_uid }}</dd>
                </div>
            </dl>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
            <div class="flex items-center mb-4">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold text-gray-900">Test RT Structure Set</h3>
            </div>
            <dl class="space-y-2 text-sm">
                <div>
                    <dt class="text-gray-500">Label</dt>
                    <dd class="text-gray-900 font-medium">{{ rtstruct2.structure_set_label }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Patient ID</dt>
                    <dd class="text-gray-900">{{ rtstruct2.patient_id }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Number of VOIs</dt>
                    <dd class="text-gray-900">{{ vois2.count }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">RT Structure Series UID</dt>
                    <dd class="text-gray-900 font-mono text-xs break-all">{{ rtstruct2.series_instance_uid }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Referenced Image Series UID</dt>
                    <dd class="text-gray-900 font-mono text-xs break-all">{{ rtstruct2.referenced_series_instance_uid }}</dd>
                </div>
            </dl>
        </div>
    </div>
    
    <!-- Series UID Validation Info -->
    {% if rtstruct1.referenced_series_instance_uid != rtstruct2.referenced_series_instance_uid %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <div class="text-sm text-red-700">
                <p class="font-medium mb-1">⚠️ Warning: Different Image Series</p>
                <p>The two RT Structures reference different image series. Spatial overlap metrics may not be meaningful as they are based on different anatomical images.</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <svg class="w-5 h-5 text-green-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <div class="text-sm text-green-700">
                <p class="font-medium mb-1">✓ Same Image Series</p>
                <p>Both RT Structures reference the same image series. Spatial overlap metrics will be calculated correctly.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %} border rounded-lg p-4 mb-4">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- VOI Pair Selection -->
    <form method="post" id="comparisonForm">
        {% csrf_token %}
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Select VOI Pairs</h3>
                    {% if matching_pairs %}
                    <p class="text-sm text-green-600 mt-1">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        {{ matching_pairs|length }} exact matching structure{{ matching_pairs|length|pluralize }} found and pre-selected
                    </p>
                    {% endif %}
                </div>
                <button type="button" id="addPairBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Pair
                </button>
            </div>
            
            <!-- Pairs Container -->
            <div id="pairsContainer" class="space-y-4">
                {% if matching_pairs %}
                    <!-- Pre-populated matching pairs -->
                    {% for match in matching_pairs %}
                    <div class="pair-row border border-green-200 bg-green-50 rounded-lg p-4" data-matched="true">
                        <!-- Debug: Match VOI1 ID = {{ match.voi1.id }}, VOI2 ID = {{ match.voi2.id }} -->
                        <div class="flex items-start gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    VOI from {{ rtstruct1.structure_set_label }}
                                </label>
                                <select name="voi1[]" class="voi-select-1 w-full" required data-match-id="{{ match.voi1.id }}">
                                    <option value="">Select a VOI...</option>
                                    {% for voi in vois1 %}
                                    <option value="{{ voi.id }}" 
                                            data-description="{{ voi.roi_description|default:'' }}"
                                            data-volume="{{ voi.roi_volume|default:'' }}"
                                            {% if voi.id == match.voi1.id %}selected{% endif %}>
                                        {{ voi.roi_name }}
                                        {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="flex items-center pt-8">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                            
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    VOI from {{ rtstruct2.structure_set_label }}
                                </label>
                                <select name="voi2[]" class="voi-select-2 w-full" required>
                                    <option value="">Select a VOI...</option>
                                    {% for voi in vois2 %}
                                    <option value="{{ voi.id }}"
                                            data-description="{{ voi.roi_description|default:'' }}"
                                            data-volume="{{ voi.roi_volume|default:'' }}"
                                            {% if voi.id == match.voi2.id %}selected{% endif %}>
                                        {{ voi.roi_name }}
                                        {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="flex items-center pt-8">
                                <button type="button" class="remove-pair-btn text-red-600 hover:text-red-800 p-2" title="Remove this pair">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- No matches - show empty pair row -->
                    <div class="pair-row border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    VOI from {{ rtstruct1.structure_set_label }}
                                </label>
                                <select name="voi1[]" class="voi-select-1 w-full" required>
                                    <option value="">Select a VOI...</option>
                                    {% for voi in vois1 %}
                                    <option value="{{ voi.id }}" 
                                            data-description="{{ voi.roi_description|default:'' }}"
                                            data-volume="{{ voi.roi_volume|default:'' }}">
                                        {{ voi.roi_name }}
                                        {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="flex items-center pt-8">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                            
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    VOI from {{ rtstruct2.structure_set_label }}
                                </label>
                                <select name="voi2[]" class="voi-select-2 w-full" required>
                                    <option value="">Select a VOI...</option>
                                    {% for voi in vois2 %}
                                    <option value="{{ voi.id }}"
                                            data-description="{{ voi.roi_description|default:'' }}"
                                            data-volume="{{ voi.roi_volume|default:'' }}">
                                        {{ voi.roi_name }}
                                        {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="flex items-center pt-8">
                                <button type="button" class="remove-pair-btn text-red-600 hover:text-red-800 p-2" title="Remove this pair">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1 a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Instructions:</strong> {% if matching_pairs %}Exact matching structures have been automatically pre-selected (highlighted in green). {% endif %}You can modify any pair using the dropdowns. Click "Add Pair" to add more pairs. Use the search feature in dropdowns to quickly find structures. Spatial overlap metrics will be computed for each pair.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="{% url 'spatial_overlap:select_comparison_pairs' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back
            </a>
            <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Create Comparisons
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    .select2-container--default .select2-selection--single {
        height: 42px !important;
        border: 1px solid #d1d5db !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem 0.75rem !important;
    }
    
    .select2-container {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 26px !important;
        padding-left: 0 !important;
        color: #374151 !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px !important;
        right: 8px !important;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
    }
    
    .select2-dropdown {
        border: 1px solid #d1d5db !important;
        border-radius: 0.375rem !important;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #3b82f6 !important;
    }
    
    .pair-row {
        transition: all 0.3s ease;
    }
    .pair-row.removing {
        opacity: 0;
        transform: translateX(-20px);
    }
</style>

<script>
$(document).ready(function() {
    let pairCount = 1;
    
    // Initialize Select2 on existing selects
    function initializeSelect2(element) {
        $(element).select2({
            placeholder: 'Search and select a VOI...',
            allowClear: true,
            width: '100%'
        });
    }
    
    // Initialize existing selects
    $('.voi-select-1, .voi-select-2').each(function() {
        initializeSelect2(this);
        // Trigger change to update Select2 display with pre-selected value
        $(this).trigger('change.select2');
    });
    
    // Add new pair
    $('#addPairBtn').click(function() {
        pairCount++;
        
        var newPair = `
            <div class="pair-row border border-gray-200 rounded-lg p-4">
                <div class="flex items-start gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            VOI from {{ rtstruct1.structure_set_label }}
                        </label>
                        <select name="voi1[]" class="voi-select-1 w-full" required>
                            <option value="">Select a VOI...</option>
                            {% for voi in vois1 %}
                            <option value="{{ voi.id }}" 
                                    data-description="{{ voi.roi_description|default:'' }}"
                                    data-volume="{{ voi.roi_volume|default:'' }}">
                                {{ voi.roi_name }}
                                {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="flex items-center pt-8">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </div>
                    
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            VOI from {{ rtstruct2.structure_set_label }}
                        </label>
                        <select name="voi2[]" class="voi-select-2 w-full" required>
                            <option value="">Select a VOI...</option>
                            {% for voi in vois2 %}
                            <option value="{{ voi.id }}"
                                    data-description="{{ voi.roi_description|default:'' }}"
                                    data-volume="{{ voi.roi_volume|default:'' }}">
                                {{ voi.roi_name }}
                                {% if voi.roi_volume %} ({{ voi.roi_volume|floatformat:2 }} cm³){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="flex items-center pt-8">
                        <button type="button" class="remove-pair-btn text-red-600 hover:text-red-800 p-2" title="Remove this pair">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        $('#pairsContainer').append(newPair);
        
        // Initialize Select2 on new selects
        $('#pairsContainer .pair-row:last-child .voi-select-1, #pairsContainer .pair-row:last-child .voi-select-2').each(function() {
            initializeSelect2(this);
        });
        
        // Scroll to new pair
        $('#pairsContainer .pair-row:last-child')[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    
    // Remove pair
    $(document).on('click', '.remove-pair-btn', function() {
        var pairRow = $(this).closest('.pair-row');
        var totalPairs = $('.pair-row').length;
        
        if (totalPairs <= 1) {
            alert('You must have at least one VOI pair.');
            return;
        }
        
        pairRow.addClass('removing');
        setTimeout(function() {
            pairRow.remove();
        }, 300);
    });
    
    // Form validation
    $('#comparisonForm').submit(function(e) {
        var voi1Selects = $('select[name="voi1[]"]');
        var voi2Selects = $('select[name="voi2[]"]');
        var isValid = true;
        var emptyPairs = 0;
        
        voi1Selects.each(function(index) {
            var voi1Value = $(this).val();
            var voi2Value = voi2Selects.eq(index).val();
            
            if (!voi1Value || !voi2Value) {
                emptyPairs++;
                isValid = false;
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please select both VOIs for all pairs, or remove empty pairs.');
            return false;
        }
        
        // Check for duplicate pairs
        var pairs = [];
        var hasDuplicates = false;
        
        voi1Selects.each(function(index) {
            var voi1Value = $(this).val();
            var voi2Value = voi2Selects.eq(index).val();
            var pairKey = voi1Value + '_' + voi2Value;
            
            if (pairs.includes(pairKey)) {
                hasDuplicates = true;
            }
            pairs.push(pairKey);
        });
        
        if (hasDuplicates) {
            if (!confirm('You have duplicate VOI pairs. Do you want to continue?')) {
                e.preventDefault();
                return false;
            }
        }
        
        return true;
    });
});
</script>
{% endblock %}
