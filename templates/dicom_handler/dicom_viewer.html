{% extends 'base.html' %}

{% block title %}DICOM Viewer - {{ series.series_instance_uid }} - DRAW v2.0{% endblock %}

{% block extra_css %}
<style>
    #viewer-container {
        position: relative;
        background: #000;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    #dicom-image {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #9333ea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .roi-checkbox {
        cursor: pointer;
    }
    
    .roi-checkbox:hover {
        background-color: #f3f4f6;
    }
    
    .slice-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 5;
    }
    
    /* Horizontal slider styling */
    #slice-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: linear-gradient(to right, #9333ea 0%, #9333ea 0%) no-repeat, #e5e7eb;
        background-size: 0% 8px;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
    }
    
    #slice-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #9333ea;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #slice-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #9333ea;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #slice-slider::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
    }
    
    #slice-slider::-moz-range-track {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">DICOM Viewer</h1>
                <p class="text-gray-600">View DICOM Images with overlaid RTStructureSet Data.</p>
            </div>
            <a href="{% url 'dicom_handler:view_rt_structure_list' series.series_instance_uid %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to RT Structure List
            </a>
        </div>
    </div>

    <!-- Patient Information -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-gray-500">Patient:</span>
                <span class="text-gray-900 font-medium ml-1">{{ patient_name }} ({{ patient_id }})</span>
            </div>
            <div>
                <span class="text-gray-500">Study Date:</span>
                <span class="text-gray-900 font-medium ml-1">
                    {% if study_date %}{{ study_date|date:"d M Y" }}{% else %}N/A{% endif %}
                </span>
            </div>
            <div>
                <span class="text-gray-500">Series:</span>
                <span class="text-gray-900 font-medium ml-1">{{ series_description|default:"N/A" }}</span>
            </div>
            <div>
                <span class="text-gray-500">Instances:</span>
                <span class="text-gray-900 font-medium ml-1">{{ instance_count }}</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Viewer Panel (Left - 3/4 width) -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <!-- Viewer Container (Full Width) -->
                <div>
                        <div id="viewer-container" class="relative flex items-center justify-center" style="min-height: 400px; max-height: 500px; background: #000; overflow: hidden;">
                            <div class="loading-overlay" id="loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                <div class="text-center text-white" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 250px;">
                                    <div class="spinner mx-auto mb-3"></div>
                                    <p id="loading-text" style="white-space: nowrap;">Loading DICOM data...</p>
                                </div>
                            </div>
                            <img id="dicom-image" src="" alt="DICOM Image" style="display: none; max-width: none; max-height: 500px; width: auto; height: auto; transition: transform 0.2s ease;">
                        </div>
                </div>
            </div>
        </div>

        <!-- Controls Panel (Right - 1/4 width) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sticky top-4 space-y-6">
                <!-- Slice Navigation Controls -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Slice Navigation</h3>
                    
                    <div class="mb-3">
                        <label for="slice-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Go to Slice: <span id="current-slice" class="font-semibold text-purple-600">0</span> / <span id="total-slices" class="text-gray-600">0</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" id="slice-input" min="1" max="1" value="1" disabled
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Enter slice #">
                            <button id="go-to-slice" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium" disabled>
                                Go
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Press Enter to jump to slice</p>
                    </div>
                    
                    <div class="px-2">
                        <input type="range" id="slice-slider" min="0" max="0" value="0" disabled class="w-full">
                    </div>
                    
                    <p class="text-xs text-gray-500 text-center mt-2">Use ↑↓ keys or mouse wheel on image</p>
                </div>
                
                <!-- Window/Level Controls -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Window/Level</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label for="window-center" class="block text-sm font-medium text-gray-700 mb-1">
                                Center: <span id="wc-value" class="font-semibold">40</span>
                            </label>
                            <input type="range" id="window-center" class="w-full" min="-1000" max="1000" value="40" step="1">
                        </div>
                        <div>
                            <label for="window-width" class="block text-sm font-medium text-gray-700 mb-1">
                                Width: <span id="ww-value" class="font-semibold">400</span>
                            </label>
                            <input type="range" id="window-width" class="w-full" min="1" max="2000" value="400" step="1">
                        </div>
                    </div>

                    <!-- Preset Window/Level Buttons -->
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="40" data-ww="400">
                            Soft Tissue
                        </button>
                        <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="-600" data-ww="1500">
                            Lung
                        </button>
                        <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="400" data-ww="1800">
                            Bone
                        </button>
                        <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="50" data-ww="350">
                            Brain
                        </button>
                        <button class="preset-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs" data-wc="60" data-ww="360">
                            Liver
                        </button>
                    </div>
                </div>

                <!-- Zoom Controls -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Zoom</h3>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Zoom Level: <span id="zoom-value" class="font-semibold">100%</span>
                        </label>
                        <input type="range" id="zoom-slider" class="w-full" min="50" max="400" value="100" step="10">
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button id="zoom-out-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm font-medium">
                            Zoom Out
                        </button>
                        <button id="zoom-reset-btn" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium">
                            Reset
                        </button>
                        <button id="zoom-in-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm font-medium">
                            Zoom In
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Use Ctrl+Scroll to zoom</p>
                </div>
                
                <!-- RT Structure Selection -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">RT Structures</h3>
                    
                    <div class="mb-3 grid grid-cols-2 gap-2">
                        <button id="select-all-roi" class="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs font-medium transition-colors">
                            Select All
                        </button>
                        <button id="deselect-all-roi" class="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs font-medium transition-colors">
                            Deselect All
                        </button>
                    </div>

                    <div id="roi-list" class="space-y-2 max-h-64 overflow-y-auto mb-3">
                        <p class="text-sm text-gray-500 text-center py-4">Loading ROI names...</p>
                    </div>

                    <button id="apply-overlay" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-medium transition-colors">
                        Apply Overlay
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success/Error Messages for Ratings -->
    <div id="rating-messages" class="mt-6" style="display: none;">
        <div id="rating-success-message" class="rounded-md p-4 bg-green-50 border border-green-200" style="display: none;">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-green-800" id="rating-success-text">
                        Ratings saved successfully!
                    </p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" class="inline-flex rounded-md bg-green-50 p-1.5 text-green-500 hover:bg-green-100 focus:outline-none" onclick="document.getElementById('rating-success-message').style.display='none'">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="rating-error-message" class="rounded-md p-4 bg-red-50 border border-red-200" style="display: none;">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-800" id="rating-error-text">
                        Error saving ratings
                    </p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" class="inline-flex rounded-md bg-red-50 p-1.5 text-red-500 hover:bg-red-100 focus:outline-none" onclick="document.getElementById('rating-error-message').style.display='none'">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contour Rating Section (Below Image Viewer) -->
    <div class="mt-6" id="rating-section" style="display: none;">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <button id="toggle-rating" class="w-full flex items-center justify-between text-xl font-semibold text-gray-900 mb-4 hover:text-purple-600 transition-colors">
                <span class="flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                    Rate Contour Quality
                    {% if has_existing_rating %}
                    <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Already Rated
                    </span>
                    {% endif %}
                </span>
                <svg id="rating-chevron" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            {% if has_existing_rating %}
            <!-- Existing Rating Info Banner -->
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-blue-800">This structure set has already been rated</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {% if existing_assessor %}
                                <div>
                                    <span class="font-semibold">Assessor:</span> {{ existing_assessor|default:"Not specified" }}
                                </div>
                                {% endif %}
                                {% if existing_date_reviewed %}
                                <div>
                                    <span class="font-semibold">Date:</span> {{ existing_date_reviewed|date:"Y-m-d" }}
                                </div>
                                {% endif %}
                                {% if existing_overall_rating %}
                                <div>
                                    <span class="font-semibold">Rating:</span> {{ existing_overall_rating }}/10
                                </div>
                                {% endif %}
                                {% if existing_modification_time %}
                                <div>
                                    <span class="font-semibold">Time:</span> {{ existing_modification_time }} min
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-blue-600">You can update the rating below.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div id="rating-content" style="{% if has_existing_rating %}display: block;{% else %}display: none;{% endif %}">
                <!-- Overall Structure Set Rating -->
                <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Overall Structure Set Quality</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Assessor Name -->
                        <div>
                            <label for="assessor-name" class="block text-sm font-medium text-gray-700 mb-2">
                                Assessor Name
                            </label>
                            <input type="text" id="assessor-name" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Enter your name"
                                   value="{{ existing_assessor|default:'' }}">
                            <p class="mt-1 text-xs text-gray-500">Name of the person reviewing the contours</p>
                        </div>
                        
                        <!-- Date Contour Reviewed -->
                        <div>
                            <label for="date-reviewed" class="block text-sm font-medium text-gray-700 mb-2">
                                Date Contour Reviewed <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="date-reviewed" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                                   required
                                   value="{% if existing_date_reviewed %}{{ existing_date_reviewed|date:'Y-m-d' }}{% endif %}">
                            <p class="mt-1 text-xs text-gray-500">Date when the contour was reviewed</p>
                        </div>
                        
                        <!-- Time Required Field -->
                        <div>
                            <label for="modification-time" class="block text-sm font-medium text-gray-700 mb-2">
                                Time Required (minutes)
                            </label>
                            <input type="number" id="modification-time" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Enter time in minutes" min="0"
                                   value="{{ existing_modification_time|default:'' }}">
                            <p class="mt-1 text-xs text-gray-500">Time required to modify the contours in minutes</p>
                        </div>
                        
                        <!-- Overall Rating Stars -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Overall Quality Rating (1-10)
                            </label>
                            <div class="flex items-center space-x-1 mb-2">
                                {% for i in "0123456789" %}
                                <button type="button" class="overall-star-button focus:outline-none" data-rating="{{ forloop.counter }}">
                                    <svg class="w-8 h-8 overall-star-icon transition-colors duration-150 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </button>
                                {% endfor %}
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Selected: <span id="overall-rating-display" class="font-semibold text-purple-600">5</span> / 10</span>
                                <span class="text-xs text-gray-500">(Click stars to rate)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Individual Structure Ratings -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Individual Structure Ratings</h3>
                    <div id="structure-ratings" class="space-y-4">
                        <p class="text-sm text-gray-500 text-center py-8 bg-gray-50 rounded-lg">Select structures and click "Apply Overlay" to rate them</p>
                    </div>
                </div>
                
                <!-- Save Button -->
                <div class="flex justify-end pt-4 border-t border-gray-200">
                    <button id="save-ratings" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium transition-colors shadow-sm">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Save All Ratings
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Viewer State
const viewerState = {
    currentSlice: 0,
    totalSlices: 0,
    windowCenter: 40,
    windowWidth: 400,
    roiNames: [],
    selectedROIs: [],
    isLoading: false,
};

// DOM Elements
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');
const dicomImage = document.getElementById('dicom-image');
const currentSliceSpan = document.getElementById('current-slice');
const totalSlicesSpan = document.getElementById('total-slices');
const sliceSlider = document.getElementById('slice-slider');
const sliceInput = document.getElementById('slice-input');
const goToSliceBtn = document.getElementById('go-to-slice');
const windowCenterInput = document.getElementById('window-center');
const windowWidthInput = document.getElementById('window-width');
const wcValueSpan = document.getElementById('wc-value');
const wwValueSpan = document.getElementById('ww-value');
const roiList = document.getElementById('roi-list');
const selectAllBtn = document.getElementById('select-all-roi');
const deselectAllBtn = document.getElementById('deselect-all-roi');
const applyOverlayBtn = document.getElementById('apply-overlay');
const zoomSlider = document.getElementById('zoom-slider');
const zoomValueSpan = document.getElementById('zoom-value');
const zoomInBtn = document.getElementById('zoom-in-btn');
const zoomOutBtn = document.getElementById('zoom-out-btn');
const zoomResetBtn = document.getElementById('zoom-reset-btn');

// Cache for pre-rendered slices
const sliceCache = new Map();

// Initialize Viewer
async function initializeViewer() {
    try {
        loadingText.textContent = 'Loading DICOM data...';
        
        const response = await fetch('{% url "dicom_handler:load_dicom_data" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                series_uid: '{{ series_uid }}',
                rt_structure_id: '{{ rt_structure_id }}',
            }),
        });

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load DICOM data');
        }

        viewerState.totalSlices = data.instance_count;
        viewerState.roiNames = data.roi_names || [];
        viewerState.roiColors = data.roi_colors || {};
        
        // Update UI
        totalSlicesSpan.textContent = viewerState.totalSlices;
        sliceSlider.max = viewerState.totalSlices - 1;
        sliceSlider.disabled = false;
        sliceInput.max = viewerState.totalSlices;
        sliceInput.disabled = false;
        goToSliceBtn.disabled = false;
        
        // Populate ROI list
        populateROIList();
        
        // For now, skip pre-rendering for large series (>100 slices) due to timeout/memory issues
        // TODO: Implement batch rendering with progress updates
        if (viewerState.totalSlices <= 100) {
            loadingText.textContent = 'Pre-rendering all slices for instant navigation...';
            await preRenderAllSlices();
            
            // Display first slice from cache if available
            if (!displayCachedSlice(0)) {
                await loadSlice(0);
            }
        } else {
            // For large series, use on-demand loading with caching
            loadingText.textContent = '';
            await loadSlice(0);
        }
        
    } catch (error) {
        console.error('Error initializing viewer:', error);
        loadingText.textContent = 'Error: ' + error.message;
    }
}

// Pre-render all slices and cache them
async function preRenderAllSlices() {
    try {
        // Get selected ROIs (will be empty on initial load)
        const selectedROIs = [];
        const checkboxes = document.querySelectorAll('#roi-list input[type="checkbox"]:checked');
        if (checkboxes.length > 0) {
            checkboxes.forEach(cb => selectedROIs.push(cb.value));
        }
        
        const response = await fetch('{% url "dicom_handler:render_all_slices" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                window_center: viewerState.windowCenter,
                window_width: viewerState.windowWidth,
                selected_rois: selectedROIs,
            }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to render slices');
        }

        // Cache all rendered slices
        data.slices.forEach(slice => {
            sliceCache.set(slice.index, {
                image: slice.image,
                metadata: slice.metadata,
            });
        });
        
        console.log(`Cached ${sliceCache.size} slices in browser memory`);
        loadingText.textContent = '';
        
    } catch (error) {
        console.error('Error pre-rendering slices:', error);
        console.error('Error details:', error.message);
        loadingText.textContent = 'Warning: Pre-rendering failed, falling back to on-demand loading';
        // Fall back to on-demand loading if pre-rendering fails
    }
}

// Display a cached slice (instant)
function displayCachedSlice(sliceIndex) {
    const cached = sliceCache.get(sliceIndex);
    if (cached) {
        // Display from cache (instant)
        dicomImage.src = 'data:image/png;base64,' + cached.image;
        currentSliceSpan.textContent = sliceIndex + 1;
        sliceSlider.value = sliceIndex;
        sliceInput.value = sliceIndex + 1;
        
        viewerState.currentSlice = sliceIndex;
        return true;
    }
    return false;
}

// Populate ROI List
function populateROIList() {
    if (viewerState.roiNames.length === 0) {
        roiList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No ROI structures found</p>';
        return;
    }

    // Helper function to generate rainbow color for fallback
    function getRainbowColor(index, total) {
        const t = index / Math.max(total - 1, 1);
        let r, g, b;
        
        if (t < 0.25) {
            r = 0;
            g = 4 * t;
            b = 1;
        } else if (t < 0.5) {
            r = 0;
            g = 1;
            b = 1 - 4 * (t - 0.25);
        } else if (t < 0.75) {
            r = 4 * (t - 0.5);
            g = 1;
            b = 0;
        } else {
            r = 1;
            g = 1 - 4 * (t - 0.75);
            b = 0;
        }
        
        // Convert to RGB 0-255
        r = Math.round(r * 255);
        g = Math.round(g * 255);
        b = Math.round(b * 255);
        
        return `rgb(${r}, ${g}, ${b})`;
    }

    roiList.innerHTML = '';
    const totalROIs = viewerState.roiNames.length;
    
    viewerState.roiNames.forEach((roiName, index) => {
        const div = document.createElement('div');
        div.className = 'roi-checkbox flex items-center p-2 rounded border border-gray-200';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `roi-${index}`;
        checkbox.value = roiName;
        checkbox.className = 'rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2';
        
        // Get color from RT Structure or use rainbow fallback
        let color;
        if (viewerState.roiColors && viewerState.roiColors[roiName]) {
            const c = viewerState.roiColors[roiName];
            color = `rgb(${c.r}, ${c.g}, ${c.b})`;
        } else {
            color = getRainbowColor(index, totalROIs);
        }
        
        // Color indicator box
        const colorBox = document.createElement('div');
        colorBox.className = 'w-4 h-4 rounded mr-2 border border-gray-300';
        colorBox.style.backgroundColor = color;
        colorBox.title = `Color for ${roiName}`;
        
        const label = document.createElement('label');
        label.htmlFor = `roi-${index}`;
        label.textContent = roiName;
        label.className = 'text-sm text-gray-700 cursor-pointer flex-1';
        
        div.appendChild(checkbox);
        div.appendChild(colorBox);
        div.appendChild(label);
        roiList.appendChild(div);
    });
}

// Load DICOM Slice
async function loadSlice(sliceIndex) {
    if (viewerState.isLoading) return;
    
    // Try to display from cache first (instant)
    if (displayCachedSlice(sliceIndex)) {
        dicomImage.style.display = 'block';
        updateSliderBackground();
        return;
    }
    
    // If not cached, load from server (fallback)
    viewerState.isLoading = true;
    loadingOverlay.style.display = 'flex';
    
    try {
        // Get selected ROIs
        const selectedROIs = Array.from(document.querySelectorAll('#roi-list input[type="checkbox"]:checked'))
            .map(cb => cb.value);
        
        const response = await fetch('{% url "dicom_handler:get_dicom_slice" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                slice_index: sliceIndex,
                window_center: viewerState.windowCenter,
                window_width: viewerState.windowWidth,
                selected_rois: selectedROIs,
            }),
        });

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load slice');
        }

        // Cache this slice for future instant access
        sliceCache.set(sliceIndex, {
            image: data.image,
            metadata: data.metadata,
        });

        // Update image
        dicomImage.src = 'data:image/png;base64,' + data.image;
        dicomImage.style.display = 'block';
        
        // Update slice info
        viewerState.currentSlice = sliceIndex;
        currentSliceSpan.textContent = sliceIndex + 1;
        
        // Update slider position (only if not currently being dragged)
        if (!isSliderDragging) {
            sliceSlider.value = sliceIndex;
            updateSliderBackground();
        }
        
        // Update input field
        sliceInput.value = sliceIndex + 1;
        
        // Show warning for failed ROIs
        if (data.failed_rois && data.failed_rois.length > 0) {
            updateFailedROIsIndicator(data.failed_rois);
        }
        
        loadingOverlay.style.display = 'none';
        
    } catch (error) {
        console.error('Error loading slice:', error);
        loadingText.textContent = 'Error: ' + error.message;
    } finally {
        viewerState.isLoading = false;
    }
}

// Update slider background fill
function updateSliderBackground() {
    const value = sliceSlider.value;
    const max = sliceSlider.max;
    const percentage = max > 0 ? (value / max) * 100 : 0;
    sliceSlider.style.backgroundSize = `${percentage}% 8px`;
}

// Update failed ROIs indicator
function updateFailedROIsIndicator(failedRois) {
    failedRois.forEach(roiName => {
        // Find the checkbox for this ROI
        const checkboxes = document.querySelectorAll('#roi-list input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.value === roiName) {
                const parentDiv = cb.closest('.roi-checkbox');
                if (parentDiv && !parentDiv.querySelector('.failed-indicator')) {
                    // Add warning indicator
                    const warning = document.createElement('span');
                    warning.className = 'failed-indicator ml-2 text-red-600 text-xs';
                    warning.innerHTML = '⚠️';
                    warning.title = `Cannot display: Invalid contour data`;
                    parentDiv.appendChild(warning);
                    
                    // Also add a red border
                    parentDiv.style.borderColor = '#dc2626';
                    parentDiv.style.backgroundColor = '#fef2f2';
                }
            }
        });
    });
}

// Event Listeners
let isSliderDragging = false;
sliceSlider.addEventListener('input', (e) => {
    updateSliderBackground();
    if (!isSliderDragging) {
        isSliderDragging = true;
        loadSlice(parseInt(e.target.value)).finally(() => {
            isSliderDragging = false;
        });
    }
});

// Slice input field - Go button
goToSliceBtn.addEventListener('click', () => {
    const sliceNumber = parseInt(sliceInput.value);
    if (sliceNumber >= 1 && sliceNumber <= viewerState.totalSlices) {
        loadSlice(sliceNumber - 1); // Convert to 0-indexed
    } else {
        alert(`Please enter a slice number between 1 and ${viewerState.totalSlices}`);
    }
});

// Slice input field - Enter key
sliceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        goToSliceBtn.click();
    }
});

// Slice input field - validate on input
sliceInput.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    if (value < 1) {
        e.target.value = 1;
    } else if (value > viewerState.totalSlices) {
        e.target.value = viewerState.totalSlices;
    }
});

// Mouse wheel scrolling - only when hovering over the image
let isMouseOverImage = false;

dicomImage.addEventListener('mouseenter', () => {
    isMouseOverImage = true;
});

dicomImage.addEventListener('mouseleave', () => {
    isMouseOverImage = false;
});

document.getElementById('viewer-container').addEventListener('wheel', (e) => {
    // Only prevent default and scroll slices if mouse is over the image
    if (isMouseOverImage) {
        e.preventDefault();
        e.stopPropagation();
        
        // Scroll up = increase slice number (move up through body)
        if (e.deltaY < 0 && viewerState.currentSlice < viewerState.totalSlices - 1) {
            loadSlice(viewerState.currentSlice + 1);
        } 
        // Scroll down = decrease slice number (move down through body)
        else if (e.deltaY > 0 && viewerState.currentSlice > 0) {
            loadSlice(viewerState.currentSlice - 1);
        }
    }
}, { passive: false });

// Window/Level controls
windowCenterInput.addEventListener('input', (e) => {
    viewerState.windowCenter = parseInt(e.target.value);
    wcValueSpan.textContent = viewerState.windowCenter;
});

windowWidthInput.addEventListener('input', (e) => {
    viewerState.windowWidth = parseInt(e.target.value);
    wwValueSpan.textContent = viewerState.windowWidth;
});

windowCenterInput.addEventListener('change', () => {
    loadSlice(viewerState.currentSlice);
});

windowWidthInput.addEventListener('change', () => {
    loadSlice(viewerState.currentSlice);
});

// Preset buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const wc = parseInt(btn.dataset.wc);
        const ww = parseInt(btn.dataset.ww);
        
        viewerState.windowCenter = wc;
        viewerState.windowWidth = ww;
        
        windowCenterInput.value = wc;
        windowWidthInput.value = ww;
        wcValueSpan.textContent = wc;
        wwValueSpan.textContent = ww;
        
        loadSlice(viewerState.currentSlice);
    });
});

// ROI selection
selectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#roi-list input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });
});

deselectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#roi-list input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
});

applyOverlayBtn.addEventListener('click', () => {
    // Clear cache to force re-render with new ROI selections
    sliceCache.clear();
    
    loadSlice(viewerState.currentSlice);
    
    // Show rating section when overlay is applied
    const ratingSection = document.getElementById('rating-section');
    if (ratingSection) {
        ratingSection.style.display = 'block';
    }
    
    // Populate structure ratings based on selected ROIs
    populateStructureRatings();
});

// Zoom Controls
function applyZoom(zoomLevel) {
    const scale = zoomLevel / 100;
    dicomImage.style.transform = `scale(${scale})`;
    dicomImage.style.transformOrigin = 'center center';
    zoomValueSpan.textContent = `${zoomLevel}%`;
    zoomSlider.value = zoomLevel;
}

zoomSlider.addEventListener('input', (e) => {
    const zoomLevel = parseInt(e.target.value);
    applyZoom(zoomLevel);
});

zoomInBtn.addEventListener('click', () => {
    const currentZoom = parseInt(zoomSlider.value);
    const newZoom = Math.min(400, currentZoom + 25);
    applyZoom(newZoom);
});

zoomOutBtn.addEventListener('click', () => {
    const currentZoom = parseInt(zoomSlider.value);
    const newZoom = Math.max(50, currentZoom - 25);
    applyZoom(newZoom);
});

zoomResetBtn.addEventListener('click', () => {
    applyZoom(100);
});

// Rating System
const ratingState = {
    overallRating: 5,
    modificationTime: null,
    assessorName: null,
    dateReviewed: null,
    structureRatings: {}
};

// Toggle rating panel
document.getElementById('toggle-rating')?.addEventListener('click', () => {
    const content = document.getElementById('rating-content');
    const chevron = document.getElementById('rating-chevron');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
});

// Initialize chevron state if form is already visible
{% if has_existing_rating %}
document.addEventListener('DOMContentLoaded', () => {
    const chevron = document.getElementById('rating-chevron');
    if (chevron) {
        chevron.style.transform = 'rotate(180deg)';
    }
});
{% endif %}

// Overall rating stars
function setOverallRating(rating) {
    ratingState.overallRating = rating;
    document.getElementById('overall-rating-display').textContent = rating;
    updateOverallStars(rating);
}

function updateOverallStars(rating) {
    const stars = document.querySelectorAll('.overall-star-icon');
    stars.forEach((star, index) => {
        const starRating = index + 1;
        if (starRating <= rating) {
            if (rating <= 3) {
                star.classList.remove('text-gray-300', 'text-yellow-400', 'text-green-500');
                star.classList.add('text-red-500');
            } else if (rating <= 6) {
                star.classList.remove('text-gray-300', 'text-red-500', 'text-green-500');
                star.classList.add('text-yellow-400');
            } else {
                star.classList.remove('text-gray-300', 'text-red-500', 'text-yellow-400');
                star.classList.add('text-green-500');
            }
        } else {
            star.classList.remove('text-red-500', 'text-yellow-400', 'text-green-500');
            star.classList.add('text-gray-300');
        }
    });
}

// Overall star click handlers
document.querySelectorAll('.overall-star-button').forEach(button => {
    button.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        setOverallRating(rating);
    });
    
    button.addEventListener('mouseenter', function() {
        const hoverRating = parseInt(this.getAttribute('data-rating'));
        updateOverallStars(hoverRating);
    });
    
    button.addEventListener('mouseleave', function() {
        updateOverallStars(ratingState.overallRating);
    });
});

// Modification time input handler
document.getElementById('modification-time')?.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    ratingState.modificationTime = value > 0 ? value : null;
});

// Assessor name input handler
document.getElementById('assessor-name')?.addEventListener('input', (e) => {
    ratingState.assessorName = e.target.value.trim() || null;
});

// Date reviewed input handler
document.getElementById('date-reviewed')?.addEventListener('input', (e) => {
    ratingState.dateReviewed = e.target.value || null;
});

// Modification types from backend
const modificationTypes = [
    {% for mod_type in modification_types %}
    { id: '{{ mod_type.id }}', name: '{{ mod_type.modification_type }}' },
    {% endfor %}
];

// Existing VOI ratings from backend
const existingVOIRatings = JSON.parse('{{ existing_voi_ratings_json|escapejs }}');

// Populate structure ratings
function populateStructureRatings() {
    const container = document.getElementById('structure-ratings');
    const selectedROIs = Array.from(document.querySelectorAll('#roi-list input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    if (selectedROIs.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8 bg-gray-50 rounded-lg">Select structures and click "Apply Overlay" to rate them</p>';
        return;
    }
    
    container.innerHTML = '';
    
    selectedROIs.forEach(roiName => {
        // Initialize rating state - check if existing rating exists first
        if (!ratingState.structureRatings[roiName]) {
            if (existingVOIRatings && existingVOIRatings[roiName]) {
                // Load existing rating
                ratingState.structureRatings[roiName] = {
                    modification: existingVOIRatings[roiName].modification || 'NO_MODIFICATION',
                    modification_types: existingVOIRatings[roiName].modification_types || [],
                    comments: existingVOIRatings[roiName].comments || ''
                };
            } else {
                // Default values for new rating
                ratingState.structureRatings[roiName] = {
                    modification: 'NO_MODIFICATION',
                    modification_types: [],
                    comments: ''
                };
            }
        }
        
        const ratingCard = document.createElement('div');
        ratingCard.className = 'border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors';
        
        // Build modification types checkboxes HTML
        let modTypesHTML = '';
        if (modificationTypes.length > 0) {
            modTypesHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-2">Modification Types</label>
                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded-md p-3 bg-gray-50 space-y-2">
                    ${modificationTypes.map(mt => `
                        <div class="flex items-center">
                            <input type="checkbox" class="modification-type-checkbox rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                   data-roi="${roiName}" data-type-id="${mt.id}" value="${mt.id}" 
                                   id="mod-type-${roiName}-${mt.id}">
                            <label for="mod-type-${roiName}-${mt.id}" class="ml-2 text-sm text-gray-700">
                                ${mt.name}
                            </label>
                        </div>
                    `).join('')}
                </div>
                <p class="mt-1 text-xs text-gray-500">Select all applicable modification types</p>
            `;
        }
        
        ratingCard.innerHTML = `
            <div class="mb-3 pb-2 border-b border-gray-200">
                <h3 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    ${roiName}
                </h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3">
                <!-- Left Column: Contour Modification -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Contour Modification
                        <span class="text-red-500">*</span>
                    </label>
                    <select class="structure-modification w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-sm" data-roi="${roiName}">
                        <option value="NO_MODIFICATION">No Modification</option>
                        <option value="MINOR_MODIFICATION">Minor Modification</option>
                        <option value="MAJOR_MODIFICATION">Major Modification</option>
                        <option value="NOT_SEGMENTED">Not Segmented</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Select the level of modification required</p>
                </div>
                
                <!-- Right Column: Modification Types -->
                <div>
                    ${modTypesHTML}
                </div>
            </div>
            
            <!-- Comments (Full Width Below) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
                <textarea class="structure-comments w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-sm" 
                          rows="3" data-roi="${roiName}" 
                          placeholder="Add any comments about the contour modification..."></textarea>
            </div>
        `;
        
        container.appendChild(ratingCard);
        
        // Add event listeners
        const modSelect = ratingCard.querySelector('.structure-modification');
        const commentsTextarea = ratingCard.querySelector('.structure-comments');
        const modTypeCheckboxes = ratingCard.querySelectorAll('.modification-type-checkbox');
        
        // Set initial values
        modSelect.value = ratingState.structureRatings[roiName].modification;
        commentsTextarea.value = ratingState.structureRatings[roiName].comments;
        
        // Set checked modification types
        modTypeCheckboxes.forEach(cb => {
            if (ratingState.structureRatings[roiName].modification_types.includes(cb.value)) {
                cb.checked = true;
            }
        });
        
        // Event listeners
        modSelect.addEventListener('change', (e) => {
            ratingState.structureRatings[roiName].modification = e.target.value;
        });
        
        modTypeCheckboxes.forEach(cb => {
            cb.addEventListener('change', (e) => {
                const typeId = e.target.value;
                if (e.target.checked) {
                    if (!ratingState.structureRatings[roiName].modification_types.includes(typeId)) {
                        ratingState.structureRatings[roiName].modification_types.push(typeId);
                    }
                } else {
                    ratingState.structureRatings[roiName].modification_types = 
                        ratingState.structureRatings[roiName].modification_types.filter(id => id !== typeId);
                }
            });
        });
        
        commentsTextarea.addEventListener('input', (e) => {
            ratingState.structureRatings[roiName].comments = e.target.value;
        });
    });
}

// Helper function to show messages
function showRatingMessage(type, message) {
    const messagesContainer = document.getElementById('rating-messages');
    const successMsg = document.getElementById('rating-success-message');
    const errorMsg = document.getElementById('rating-error-message');
    const successText = document.getElementById('rating-success-text');
    const errorText = document.getElementById('rating-error-text');
    
    // Hide both messages first
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';
    
    // Show the appropriate message
    if (type === 'success') {
        successText.textContent = message;
        successMsg.style.display = 'block';
        messagesContainer.style.display = 'block';
        
        // Scroll to message
        messagesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            successMsg.style.display = 'none';
            if (errorMsg.style.display === 'none') {
                messagesContainer.style.display = 'none';
            }
        }, 5000);
    } else {
        errorText.textContent = message;
        errorMsg.style.display = 'block';
        messagesContainer.style.display = 'block';
        
        // Scroll to message
        messagesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Save ratings
document.getElementById('save-ratings')?.addEventListener('click', async () => {
    const saveBtn = document.getElementById('save-ratings');
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<svg class="w-5 h-5 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving Ratings...';
        
        const response = await fetch('{% url "dicom_handler:save_contour_ratings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                series_uid: '{{ series.series_instance_uid }}',
                overall_rating: ratingState.overallRating,
                modification_time: ratingState.modificationTime,
                assessor_name: ratingState.assessorName,
                date_reviewed: ratingState.dateReviewed,
                structure_ratings: ratingState.structureRatings
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update button to show success
            saveBtn.innerHTML = '<svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Saved Successfully!';
            saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.add('bg-green-500');
            
            // Show success message
            const structureCount = Object.keys(ratingState.structureRatings).length;
            showRatingMessage('success', `Successfully saved ratings for ${structureCount} structure(s) with overall rating of ${ratingState.overallRating}/10`);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('bg-green-500');
                saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                saveBtn.disabled = false;
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to save ratings');
        }
    } catch (error) {
        console.error('Error saving ratings:', error);
        
        // Show error message
        showRatingMessage('error', `Failed to save ratings: ${error.message}`);
        
        // Reset button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
});

// Initialize overall rating stars and form with existing values if available
{% if has_existing_rating and existing_overall_rating %}
const initialRating = {{ existing_overall_rating }};
ratingState.overallRating = initialRating;
document.getElementById('overall-rating-display').textContent = initialRating;
updateOverallStars(initialRating);
{% else %}
updateOverallStars(5);
{% endif %}

// Initialize rating state with existing values
{% if existing_assessor %}
ratingState.assessorName = '{{ existing_assessor|escapejs }}';
{% endif %}
{% if existing_date_reviewed %}
ratingState.dateReviewed = '{{ existing_date_reviewed|date:"Y-m-d" }}';
{% endif %}
{% if existing_modification_time %}
ratingState.modificationTime = {{ existing_modification_time }};
{% endif %}

// Cleanup on page unload
window.addEventListener('beforeunload', async () => {
    await fetch('{% url "dicom_handler:cleanup_temp_files" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
    });
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    // Only handle arrow keys if not typing in an input
    if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;
    
    if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
        e.preventDefault();
        if (viewerState.currentSlice < viewerState.totalSlices - 1) {
            loadSlice(viewerState.currentSlice + 1);
        }
    } else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
        e.preventDefault();
        if (viewerState.currentSlice > 0) {
            loadSlice(viewerState.currentSlice - 1);
        }
    }
});

// Initialize viewer on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeViewer();
});
</script>
{% endblock %}
