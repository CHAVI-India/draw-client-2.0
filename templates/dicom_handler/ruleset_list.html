{% extends 'base.html' %}
{% load cotton %}

{% block title %}RuleSets - DRAW v2.0{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8">
        <!-- Header with Title and Button -->
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">RuleSets</h1>
            </div>
            {% if perms.dicom_handler.add_ruleset %}
                <a href="{% url 'dicom_handler:ruleset_create' %}" 
                   class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors whitespace-nowrap">
                    Create New RuleSet
                </a>
            {% endif %}
        </div>
        
        <!-- Description Section -->
        <div class="mb-8">
            <p class="text-gray-600 text-sm">Rulesets are a collection of rules which ensure that the correct automatic segmentation template to be selected for each case. Each Ruleset comprises of a set of rules. Each rule in turn is a statement that evaluates a user provided value for a given DICOM tag agains the actual value in the DICOM file. For example, if the Protocol name is "Brain MRI" and the actual Protocol Name is "Brain MRI", then the rule will evaluate to true. Multiple such rules can be present in a ruleset and they can be combined using a OR or AND operator. The OR operator allows us to select a template if any one of the rules evaluate to true. The AND operator allows us to select a template only if all the rules evaluate to true.</p>
            <p class="text-gray-600 text-sm mt-4">To create a new Ruleset click on the "Create New RuleSet" button above. View all available rulesets below.</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% else %}bg-green-50 border border-green-200 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% if rulesets %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                RuleSet Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Description
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Combination Type
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Associated Template
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Rules Count
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for ruleset in rulesets %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">
                                        <a href="{% url 'dicom_handler:ruleset_detail' ruleset.id %}" 
                                           class="text-primary-600 hover:text-primary-900 hover:underline">
                                            {{ ruleset.ruleset_name }}
                                        </a>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-500 max-w-xs truncate">
                                        {{ ruleset.ruleset_description|default:"No description" }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if ruleset.rule_combination_type == 'AND' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                                        {{ ruleset.get_rule_combination_type_display }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        {% if ruleset.associated_autosegmentation_template %}
                                            <a href="{% url 'dicom_handler:template_detail' ruleset.associated_autosegmentation_template.id %}"
                                               class="text-primary-600 hover:text-primary-900 hover:underline">
                                                {{ ruleset.associated_autosegmentation_template.template_name }}
                                            </a>
                                        {% else %}
                                            <span class="text-gray-400">No template assigned</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        {{ ruleset.rule_count }} rule{{ ruleset.rule_count|pluralize }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ ruleset.created_at|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        {% if perms.dicom_handler.view_ruleset %}
                                            <c-button variant="primary" size="sm" icon="eye" href="{% url 'dicom_handler:ruleset_detail' ruleset.id %}">View</c-button>
                                        {% endif %}
                                        {% if perms.dicom_handler.change_ruleset %}
                                            <c-button variant="secondary" size="sm" icon="edit" href="{% url 'dicom_handler:ruleset_edit' ruleset.id %}">Edit</c-button>
                                        {% endif %}
                                        {% if perms.dicom_handler.delete_ruleset %}
                                            <c-button variant="danger" size="sm" icon="trash" href="{% url 'dicom_handler:ruleset_delete' ruleset.id %}">Delete</c-button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No RuleSets</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by creating a new ruleset.</p>
                <div class="mt-6">
                    {% if perms.dicom_handler.add_ruleset %}
                        <a href="{% url 'dicom_handler:ruleset_create' %}" 
                           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                            Create New RuleSet
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
