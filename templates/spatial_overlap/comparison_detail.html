{% extends 'base.html' %}

{% block title %}Comparison Detail - DRAW{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Comparison Detail</h1>
                <p class="mt-2 text-gray-600">Spatial overlap metrics for VOI comparison #{{ comparison.id }}</p>
            </div>
            <a href="{% url 'spatial_overlap:list_comparisons' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to List
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %} border rounded-lg p-4 mb-4">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Comparison Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
            <div class="flex items-center mb-4">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold text-gray-900">Reference VOI</h3>
            </div>
            <dl class="space-y-2 text-sm">
                <div>
                    <dt class="text-gray-500">ROI Name</dt>
                    <dd class="text-gray-900 font-medium">{{ comparison.first_rtstructure.roi_name }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">ROI Number</dt>
                    <dd class="text-gray-900">{{ comparison.first_rtstructure.roi_number }}</dd>
                </div>
                {% if comparison.first_rtstructure.roi_volume %}
                <div>
                    <dt class="text-gray-500">Volume</dt>
                    <dd class="text-gray-900">{{ comparison.first_rtstructure.roi_volume|floatformat:2 }} cm³</dd>
                </div>
                {% endif %}
                <div>
                    <dt class="text-gray-500">RT Structure Set</dt>
                    <dd class="text-gray-900">{{ comparison.first_rtstructure.rtstructure_set_file.structure_set_label }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Patient ID</dt>
                    <dd class="text-gray-900">{{ comparison.first_rtstructure.rtstructure_set_file.patient_id }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Referenced Series UID</dt>
                    <dd class="text-gray-900 text-xs font-mono">{{ comparison.first_rtstructure.rtstructure_set_file.referenced_series_instance_uid|default:"Not specified" }}</dd>
                </div>
            </dl>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
            <div class="flex items-center mb-4">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold text-gray-900">Test VOI</h3>
            </div>
            <dl class="space-y-2 text-sm">
                <div>
                    <dt class="text-gray-500">ROI Name</dt>
                    <dd class="text-gray-900 font-medium">{{ comparison.second_rtstructure.roi_name }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">ROI Number</dt>
                    <dd class="text-gray-900">{{ comparison.second_rtstructure.roi_number }}</dd>
                </div>
                {% if comparison.second_rtstructure.roi_volume %}
                <div>
                    <dt class="text-gray-500">Volume</dt>
                    <dd class="text-gray-900">{{ comparison.second_rtstructure.roi_volume|floatformat:2 }} cm³</dd>
                </div>
                {% endif %}
                <div>
                    <dt class="text-gray-500">RT Structure Set</dt>
                    <dd class="text-gray-900">{{ comparison.second_rtstructure.rtstructure_set_file.structure_set_label }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Patient ID</dt>
                    <dd class="text-gray-900">{{ comparison.second_rtstructure.rtstructure_set_file.patient_id }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Referenced Series UID</dt>
                    <dd class="text-gray-900 text-xs font-mono">{{ comparison.second_rtstructure.rtstructure_set_file.referenced_series_instance_uid|default:"Not specified" }}</dd>
                </div>
            </dl>
        </div>
    </div>
    
    {% if has_results %}
    <!-- Metrics Results -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Spatial Overlap Metrics</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Metric
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Value
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for result in results %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ result.get_comparision_type_display }}</div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="text-sm font-bold text-gray-900">{{ result.result_value|floatformat:4 }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MDC Histogram Visualization -->
    {% if mdc_histogram_data %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Distance to Conformity Analysis</h3>
            <p class="text-sm text-gray-600 mt-1">Slice-wise conformity error distribution (similar to error-volume histogram)</p>
        </div>
        
        <div class="p-6">
            <!-- Only show MDC tab (remove redundant under/over tabs) -->
            {% if 'mdc' in mdc_histogram_data %}
            <div id="content-mdc" class="mdc-content">
                <!-- Split Histograms -->
                <div class="mb-8">
                    <h4 class="text-md font-semibold text-gray-800 mb-4">Conformity Error Distribution (All Slices)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Undercontouring (Negative) -->
                        <div>
                            <h5 class="text-sm font-medium text-red-700 mb-2 text-center">Undercontouring (Reference extends beyond Test)</h5>
                            <canvas id="histogram-under" height="120"></canvas>
                        </div>
                        <!-- Overcontouring (Positive) -->
                        <div>
                            <h5 class="text-sm font-medium text-blue-700 mb-2 text-center">Overcontouring (Test extends beyond Reference)</h5>
                            <canvas id="histogram-over" height="120"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Per-Slice Statistics -->
                <div class="mt-8">
                    <h4 class="text-md font-semibold text-gray-800 mb-4">Per-Slice Statistics</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slice</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Under Count</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Under Mean (mm)</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Over Count</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Over Mean (mm)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="slice-table-mdc">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="flex gap-4">
        <form method="post" action="{% url 'spatial_overlap:delete_comparison' comparison.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this comparison and all its results?');">
            {% csrf_token %}
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete Comparison
            </button>
        </form>
    </div>
    
    <!-- Info about temporary files -->
    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h4 class="text-sm font-medium text-blue-800">Note</h4>
                <p class="mt-1 text-sm text-blue-700">
                    Metrics are computed once and stored. The source DICOM files are kept in temporary storage and may be cleaned up over time.
                </p>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Results Yet -->
    <div class="bg-white rounded-lg shadow-md p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No Metrics Computed Yet</h3>
        <p class="mt-1 text-sm text-gray-500">Compute spatial overlap metrics for this comparison.</p>
        <div class="mt-6">
            <form method="post" action="{% url 'spatial_overlap:compute_metrics' comparison.id %}">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    Compute Metrics
                </button>
            </form>
        </div>
        
        <!-- Requirements Info -->
        <div class="mt-8 max-w-2xl mx-auto">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-left">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h4 class="text-sm font-medium text-yellow-800">Requirements for Metric Computation</h4>
                        <p class="mt-2 text-sm text-yellow-700">
                            The DICOM image series referenced by these RT Structures must exist in the database. 
                            Check the "Referenced Series UID" above and ensure those series have been imported through the DICOM import workflow.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if mdc_histogram_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// MDC histogram data from Django
const mdcData = {
    {% for metric_type, data in mdc_histogram_data.items %}
    '{{ metric_type }}': {
        sliceData: {{ data.slice_data_json|safe }},
        allUnderDistances: {{ data.all_under_distances|safe }},
        allOverDistances: {{ data.all_over_distances|safe }},
        overlapCount: {{ data.overlap_count }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Create histograms for each metric type
const charts = {};

function createSplitHistograms(metricType) {
    const data = mdcData[metricType];
    
    console.log('Creating split histograms for:', metricType);
    console.log('Data:', data);
    
    if (!data) {
        console.error('No data found for:', metricType);
        return;
    }
    
    const binWidth = 0.1; // 0.1mm bins
    
    // Process undercontouring data (negative values, but we'll show as positive distances from 0)
    const underDistances = data.allUnderDistances.map(d => Math.abs(d));
    const maxUnderDist = underDistances.length > 0 ? Math.max(...underDistances) : 0;
    
    // Process overcontouring data (positive values)
    const overDistances = data.allOverDistances.map(d => Math.abs(d));
    const maxOverDist = overDistances.length > 0 ? Math.max(...overDistances) : 0;
    
    // Calculate total volume (all voxels: overlapping + error voxels)
    // Total = undercontouring voxels + overcontouring voxels + overlapping voxels
    const totalVoxels = underDistances.length + overDistances.length + data.overlapCount;
    
    console.log('Total voxels:', totalVoxels, '(under:', underDistances.length, '+ over:', overDistances.length, '+ overlap:', data.overlapCount, ')');
    
    // Create undercontouring histogram (left side, showing distances from 0)
    createUnderHistogram(underDistances, maxUnderDist, binWidth, totalVoxels);
    
    // Create overcontouring histogram (right side, showing distances from 0)
    createOverHistogram(overDistances, maxOverDist, binWidth, totalVoxels);
}

function createUnderHistogram(distances, maxDist, binWidth, totalVoxels) {
    const ctx = document.getElementById('histogram-under');
    if (!ctx) return;
    
    const numBins = Math.ceil(maxDist / binWidth);
    const bins = new Array(numBins).fill(0);
    const binLabels = [];
    
    // Create bins from 0 to maxDist
    for (let i = 0; i < numBins; i++) {
        const binStart = i * binWidth;
        binLabels.push(binStart.toFixed(1));
    }
    
    // Fill bins
    distances.forEach(dist => {
        const binIndex = Math.floor(dist / binWidth);
        if (binIndex >= 0 && binIndex < numBins) {
            bins[binIndex]++;
        }
    });
    
    // Convert to percentages using total volume (all voxels)
    const binPercentages = bins.map(count => (count / totalVoxels) * 100);
    
    if (charts['under']) {
        charts['under'].destroy();
    }
    
    charts['under'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: binLabels,
            datasets: [{
                label: 'Volume %',
                data: binPercentages,
                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                borderColor: 'rgba(239, 68, 68, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y.toFixed(2)}% of volume`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Distance from 0 (mm)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function(value, index) {
                            return index % 5 === 0 ? this.getLabelForValue(value) : '';
                        }
                    },
                    reverse: true  // Reverse to show 0 on the right
                },
                y: {
                    title: {
                        display: true,
                        text: 'Volume %'
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

function createOverHistogram(distances, maxDist, binWidth, totalVoxels) {
    const ctx = document.getElementById('histogram-over');
    if (!ctx) return;
    
    const numBins = Math.ceil(maxDist / binWidth);
    const bins = new Array(numBins).fill(0);
    const binLabels = [];
    
    // Create bins from 0 to maxDist
    for (let i = 0; i < numBins; i++) {
        const binStart = i * binWidth;
        binLabels.push(binStart.toFixed(1));
    }
    
    // Fill bins
    distances.forEach(dist => {
        const binIndex = Math.floor(dist / binWidth);
        if (binIndex >= 0 && binIndex < numBins) {
            bins[binIndex]++;
        }
    });
    
    // Convert to percentages using total volume (all voxels)
    const binPercentages = bins.map(count => (count / totalVoxels) * 100);
    
    if (charts['over']) {
        charts['over'].destroy();
    }
    
    charts['over'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: binLabels,
            datasets: [{
                label: 'Volume %',
                data: binPercentages,
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y.toFixed(2)}% of volume`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Distance from 0 (mm)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function(value, index) {
                            return index % 5 === 0 ? this.getLabelForValue(value) : '';
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Volume %'
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

function populateSliceTable(metricType) {
    const data = mdcData[metricType];
    const tableBody = document.getElementById(`slice-table-${metricType}`);
    
    if (!tableBody || !data) return;
    
    tableBody.innerHTML = '';
    
    // Sort slice indices
    const sliceIndices = Object.keys(data.sliceData).map(Number).sort((a, b) => a - b);
    
    sliceIndices.forEach(sliceIdx => {
        const sliceData = data.sliceData[sliceIdx];
        const underDists = sliceData.under_distances || [];
        const overDists = sliceData.over_distances || [];
        
        const underMean = underDists.length > 0 
            ? (underDists.reduce((a, b) => a + b, 0) / underDists.length).toFixed(2)
            : '0.00';
        const overMean = overDists.length > 0 
            ? (overDists.reduce((a, b) => a + b, 0) / overDists.length).toFixed(2)
            : '0.00';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${sliceIdx}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">${underDists.length}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">${underMean}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">${overDists.length}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">${overMean}</td>
        `;
        tableBody.appendChild(row);
    });
}

// Initialize charts and table on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    console.log('MDC Data:', mdcData);
    
    if (mdcData['mdc']) {
        console.log('Initializing MDC split histograms and table');
        createSplitHistograms('mdc');
        populateSliceTable('mdc');
    } else {
        console.error('No MDC data found in mdcData object');
    }
});
</script>
{% endif %}

{% endblock %}
