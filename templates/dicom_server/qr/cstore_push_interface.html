{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - DRAW Client{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Send Files to {{ node.name }}</h1>
                <p class="text-gray-600">Select DICOM series to send via C-STORE</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'dicom_server:remote_nodes_list' %}" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                    ‚Üê Back to Nodes
                </a>
            </div>
        </div>
    </div>

    <!-- Node Information Card -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Destination Node Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-600">AE Title</p>
                <p class="font-medium">{{ node.incoming_ae_title }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Host</p>
                <p class="font-medium">{{ node.host }}:{{ node.port }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Status</p>
                {% if node.is_active %}
                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">Active</span>
                {% else %}
                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">Inactive</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Series</h3>
        <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="patient_id" class="block text-sm font-medium text-gray-700 mb-2">Patient ID</label>
                <input type="text" id="patient_id" name="patient_id" value="{{ patient_id }}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Search by Patient ID">
            </div>
            <div>
                <label for="study_uid" class="block text-sm font-medium text-gray-700 mb-2">Study UID</label>
                <input type="text" id="study_uid" name="study_uid" value="{{ study_uid }}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Search by Study UID">
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Selection Actions -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="selectAll()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition text-sm">
                    Select All
                </button>
                <button onclick="deselectAll()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition text-sm">
                    Deselect All
                </button>
                <span id="selection-count" class="text-gray-700 font-medium">0 series selected</span>
            </div>
            <button onclick="sendSelectedSeries()" id="send-button" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                üì§ Send Selected Series
            </button>
        </div>
    </div>

    <!-- Series List -->
    {% if series_list %}
        <div class="space-y-4">
            {% for series in series_list %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-start">
                    <input type="checkbox" class="series-checkbox mt-1 mr-4 h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" 
                           data-series-uid="{{ series.series_instance_uid }}" 
                           onchange="updateSelectionCount()">
                    <div class="flex-1">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Patient ID</p>
                                <p class="font-medium">{{ series.study.patient.patient_id|truncatechars:20 }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Study Date</p>
                                <p class="font-medium">{{ series.study.study_date|date:"Y-m-d"|default:"N/A" }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Modality</p>
                                <p class="font-medium">{{ series.modality|default:"N/A" }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Series Description</p>
                                <p class="font-medium">{{ series.series_description|truncatechars:30|default:"N/A" }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Number of Instances</p>
                                <p class="font-medium">{{ series.number_of_instances|default:"0" }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Processing Status</p>
                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                                    {{ series.series_processsing_status }}
                                </span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Series UID</p>
                                <p class="font-mono text-xs text-gray-700">{{ series.series_instance_uid|truncatechars:30 }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Created</p>
                                <p class="font-medium">{{ series.created_at|date:"Y-m-d H:i" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if series_list.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="inline-flex rounded-md shadow">
                {% if series_list.has_previous %}
                    <a href="?page={{ series_list.previous_page_number }}{% if patient_id %}&patient_id={{ patient_id }}{% endif %}{% if study_uid %}&study_uid={{ study_uid }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Previous
                    </a>
                {% endif %}
                <span class="px-4 py-2 bg-white border-t border-b border-gray-300 text-sm text-gray-700">
                    Page {{ series_list.number }} of {{ series_list.paginator.num_pages }}
                </span>
                {% if series_list.has_next %}
                    <a href="?page={{ series_list.next_page_number }}{% if patient_id %}&patient_id={{ patient_id }}{% endif %}{% if study_uid %}&study_uid={{ study_uid }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Next
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    {% else %}
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">No Series Available</h3>
            <p class="mt-2 text-gray-600">No completed or exported series found. Try adjusting your filters.</p>
        </div>
    {% endif %}
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100">
                <svg class="animate-spin h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Sending Files...</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="progress-message">
                    Please wait while files are being sent to {{ node.name }}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('.series-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selection-count').textContent = `${count} series selected`;
    document.getElementById('send-button').disabled = count === 0;
}

function selectAll() {
    document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = true);
    updateSelectionCount();
}

function deselectAll() {
    document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = false);
    updateSelectionCount();
}

function sendSelectedSeries() {
    const checkboxes = document.querySelectorAll('.series-checkbox:checked');
    const seriesUids = Array.from(checkboxes).map(cb => cb.dataset.seriesUid);
    
    if (seriesUids.length === 0) {
        alert('Please select at least one series to send');
        return;
    }
    
    if (!confirm(`Send ${seriesUids.length} series to {{ node.name }}?`)) {
        return;
    }
    
    // Show progress modal
    document.getElementById('progress-modal').classList.remove('hidden');
    
    // Send request
    fetch('{% url "dicom_server:cstore_push_send" node.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            series_uids: seriesUids
        })
    })
    .then(response => response.json())
    .then(data => {
        // Hide progress modal
        document.getElementById('progress-modal').classList.add('hidden');
        
        if (data.success) {
            alert(`Success! Sent ${data.sent_count}/${data.total_files} files to {{ node.name }}`);
            // Deselect all after successful send
            deselectAll();
        } else {
            alert(`Error: ${data.error_message || 'Failed to send files'}\n\nSent: ${data.sent_count}/${data.total_files}`);
        }
    })
    .catch(error => {
        document.getElementById('progress-modal').classList.add('hidden');
        alert(`Error: ${error.message}`);
    });
}
</script>
{% endblock %}
